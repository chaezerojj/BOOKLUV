<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ room.name }} ëŒ€ê¸°ì‹¤</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { display: flex; gap: 20px; }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-area { flex: 3; }
        #chat-log { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; }
        .message { display: flex; align-items: flex-start; margin-bottom: 10px; }
        /* ë‚´ ë©”ì‹œì§€ */
        .message.self { justify-content: flex-end; }
        .message.self .message-content { background: #FFF9C4; text-align: right; }  /* ì—°ë…¸ë€ìƒ‰ ë°°ê²½ */
        .message.other { justify-content: flex-start; }
        .message-content { background: #f5f5f5; padding: 6px 10px; border-radius: 8px; max-width: 70%; }

        .avatar { width: 36px; height: 36px; border-radius: 50%; background: #4CAF50; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-right: 8px; }
        .message-header { display: flex; justify-content: space-between; font-size: 12px; color: #555; }
        .system { color: gray; font-style: italic; }

        /* ì°¸ì—¬ì íŒ¨ë„ */
        .participants-area { flex: 1; border: 1px solid #ddd; padding: 10px; }
        .participants-area h4 { margin-top: 0; }
        .participants-area li { list-style: none; margin-bottom: 6px; }
        .leader { color: gold; font-weight: bold; } /* ë°©ì¥ í‘œì‹œ */
    </style>
</head>
<body>
<h1>{{ room.name }} ëŒ€ê¸°ì‹¤</h1>

<div class="container">

    <!-- ğŸ’¬ ì±„íŒ… -->
    <div class="chat-area">
        {% if can_chat %}
            <p style="color:green;">íšŒì˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        {% else %}
            <p style="color:red;">íšŒì˜ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
        {% endif %}

        <div id="chat-log"></div>
        <input id="chat-message-input" {% if not can_chat %}disabled{% endif %}>
        <button id="chat-message-submit" {% if not can_chat %}disabled{% endif %}>ì „ì†¡</button>
    </div>

    <!-- ğŸ‘¥ ì°¸ì—¬ì -->
    <div class="participants-area">
        <h4>ğŸ‘¥ ì°¸ì—¬ì
            <span id="count" style="font-size:14px; color:gray;">
                ({{ joined_members }}/{{ total_members }})
            </span>
        </h4>

        <ul id="participants">
            <li data-user-id="{{ leader.id }}" class="leader">ğŸ‘‘ {{ leader.nickname }}</li>  <!-- ë°©ì¥ í‘œì‹œ -->
            {% for p in participants %}
                <li data-user-id="{{ p.user_id.id }}" {% if p.user_id.id == leader.id %}class="leader"{% endif %}> 
                    {% if p.user_id.id == leader.id %}ğŸ‘‘ {% endif %}{{ p.user_id.nickname }}
                </li>
            {% endfor %}
        </ul>
    </div>

</div>

<script>
const roomName = "{{ room.slug }}";
const currentUserId = "{{ user.id }}"; // í˜„ì¬ ì ‘ì†í•œ ìœ ì € ID
const canChat = {{ can_chat|yesno:"true,false" }}; // íšŒì˜ ê°€ëŠ¥ ì—¬ë¶€
let socket = null;

// ì‹œê°„ í¬ë§·
function formatTime(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", hour12: true });
}

// WebSocket ì—°ê²°
function connect() {
    const protocol = location.protocol === "https:" ? "wss://" : "ws://";
    socket = new WebSocket(protocol + location.host + "/ws/chat/" + roomName + "/");

    socket.onmessage = e => {
        const data = JSON.parse(e.data);
        console.log("WebSocket ë©”ì‹œì§€:", data);  // ë°ì´í„° ë¡œê·¸ í™•ì¸
        const chatLog = document.getElementById("chat-log");

        // ì‹œìŠ¤í…œ ë©”ì‹œì§€
        if (data.type === "system") {
            const p = document.createElement("p");
            p.className = "system";
            p.textContent = data.message;
            chatLog.appendChild(p);
        }

        // ì¼ë°˜ ì±„íŒ…
        if (data.type === "chat") {
            const wrapper = document.createElement("div");
            wrapper.className = data.user_id == currentUserId ? "message self" : "message other";

            const avatar = document.createElement("div");
            avatar.className = "avatar";
            avatar.textContent = data.username[0];

            const content = document.createElement("div");
            content.className = "message-content";

            const header = document.createElement("div");
            header.className = "message-header";
            header.innerHTML = `<span>${data.username}</span>
                                <span>${formatTime(data.timestamp)}</span>`;

            const body = document.createElement("div");
            body.textContent = data.message;

            content.appendChild(header);
            content.appendChild(body);

            if (data.user_id == currentUserId) {
                wrapper.appendChild(content);
                wrapper.appendChild(avatar);
            } else {
                wrapper.appendChild(avatar);
                wrapper.appendChild(content);
            }

            chatLog.appendChild(wrapper);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // ì°¸ì—¬ì ìƒíƒœ
        if (data.type === "participants") {
            console.log("ì°¸ì—¬ì ìƒíƒœ ì—…ë°ì´íŠ¸:", data.participants); // ë°ì´í„° ë¡œê·¸ í™•ì¸
            updateParticipants(data.participants);
        }
    };

    socket.onclose = () => setTimeout(connect, 3000);
}

connect();

// ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
function sendMessage() {
    const input = document.getElementById("chat-message-input");
    if (!input.value) return;
    socket.send(JSON.stringify({ message: input.value }));
    input.value = "";
}

// ë²„íŠ¼ í´ë¦­ ì „ì†¡
document.getElementById("chat-message-submit").addEventListener("click", sendMessage);

// Enter í‚¤ ì „ì†¡
document.getElementById("chat-message-input").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// ì°¸ì—¬ì ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateParticipants(participants) {
    const ul = document.getElementById("participants");
    ul.innerHTML = '';  // ê¸°ì¡´ ì°¸ì—¬ì ëª©ë¡ì„ ë¹„ì›€

    let onlineCount = 0;

    participants.forEach(p => {
        const li = document.createElement("li");
        li.dataset.userId = p.id;
        li.textContent = p.username;

        // ë°©ì¥ í‘œì‹œ
        if (p.id === {{ leader.id }}) {
            li.classList.add("leader");  // ë°©ì¥ í´ë˜ìŠ¤ ì¶”ê°€
            li.textContent = `ğŸ‘‘ ${p.username}`; // ë°©ì¥ ì•ì— ğŸ‘‘ í‘œì‹œ
        }

        // ì˜¨ë¼ì¸ ì—¬ë¶€ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
        if (p.online) {
            li.style.color = "green";  // ì˜¨ë¼ì¸ì€ ì´ˆë¡ìƒ‰
            li.style.fontWeight = "bold";  // ì˜¨ë¼ì¸ì€ êµµì€ ê¸€ì”¨
            onlineCount++;
        } else {
            li.style.color = "gray";  // ì˜¤í”„ë¼ì¸ì€ íšŒìƒ‰
            li.style.fontWeight = "normal";  // ì˜¤í”„ë¼ì¸ì€ ë³´í†µ ê¸€ì”¨
        }

        ul.appendChild(li);
    });

    document.getElementById("count").textContent = `(${onlineCount} / {{ total_members }})`;
}
</script>

</body>
</html>
