<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ room.name }} - ÎåÄÍ∏∞Ïã§</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; height: 85vh; }

        .chat-area { flex: 3; display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        #chat-log { flex: 1; overflow-y: auto; padding: 20px; background-color: #f9f9f9; display: flex; flex-direction: column; }
        
        .message { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .message.self { justify-content: flex-end; }
        .message-content { padding: 10px 14px; border-radius: 12px; max-width: 60%; font-size: 14px; position: relative; }
        .message.self .message-content { background: #fee500; color: #3c1e1e; border-top-right-radius: 2px; margin-right: 8px; }
        .message.other .message-content { background: white; border: 1px solid #ddd; border-top-left-radius: 2px; margin-left: 8px; }

        .message-header { font-size: 11px; color: #888; margin-bottom: 4px; display: flex; gap: 8px; }
        .system { text-align: center; color: #888; font-size: 12px; margin: 10px 0; background: #eee; border-radius: 20px; padding: 2px 10px; align-self: center; }

        .input-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        #chat-message-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        #chat-message-submit { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* Ï∞∏Ïó¨Ïûê Ìå®ÎÑê Î∞è ÏÉÅÌÉú ÌëúÏãú */
        .participants-area { flex: 1; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .participant-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-size: 14px; }
        
        /* Ï¥àÎ°ùÏÉâ Î∂à Í∞ïÏ†ú Ï†ÅÏö© */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-dot.online { background-color: #4CAF50 !important; box-shadow: 0 0 5px #4CAF50; }
        .status-dot.offline { background-color: #ccc !important; }
        
        .leader-crown { color: #f1c40f; margin-right: 4px; }
    </style>
</head>
<body>

<h1>{{ room.name }} ÎåÄÍ∏∞Ïã§</h1>

<div class="container">
    <div class="chat-area">
        <div id="chat-log">
            {% for msg in messages %}
                <div class="message {% if msg.user_id|slugify == user.id|slugify %}self{% else %}other{% endif %}">
                    <div class="message-content">
                        <div class="message-header">
                            <strong>{{ msg.username }}</strong>
                            <span>{{ msg.timestamp }}</span>
                        </div>
                        <div class="message-body">{{ msg.message }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="input-area">
            <input id="chat-message-input" type="text" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." {% if not can_chat %}disabled{% endif %}>
            <button id="chat-message-submit" {% if not can_chat %}disabled{% endif %}>Ï†ÑÏÜ°</button>
        </div>
    </div>

    <div class="participants-area">
        <h4>üë• Ï∞∏Ïó¨Ïûê <span id="count" style="color:#888;">(0/{{ total_members }})</span></h4>
        <ul id="participants" style="list-style: none; padding: 0;">
            {% for p in participants %}
                <li class="participant-item" id="p-{{ p.id }}">
                    <span class="status-dot offline"></span>
                    <span>
                        {% if p.id|slugify == leader.id|slugify %}<span class="leader-crown">üëë</span>{% endif %}
                        {{ p.nickname }}
                    </span>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    const roomName = "{{ room.slug }}";
    const currentUserId = String("{{ user.id }}");
    const leaderId = String("{{ leader.id }}");
    let chatSocket = null;

    const chatLog = document.querySelector('#chat-log');
    chatLog.scrollTop = chatLog.scrollHeight;

    function connect() {
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        chatSocket = new WebSocket(protocol + window.location.host + "/ws/chat/" + roomName + "/");

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("ÏàòÏã† Îç∞Ïù¥ÌÑ∞:", data);

            if (data.type === "chat" || data.type === "system") {
                renderMessage(data);
            } else if (data.type === "participants") {
                updateParticipantsList(data.participants);
            }
        };

        chatSocket.onclose = function() { setTimeout(connect, 3000); };
    }

    function renderMessage(data) {
        const div = document.createElement('div');
        if (data.type === "system") {
            div.className = 'system';
            div.textContent = data.message;
        } else {
            const isSelf = String(data.user_id) === currentUserId;
            div.className = `message ${isSelf ? 'self' : 'other'}`;
            
            let timeStr = "";
            try {
                timeStr = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch(e) { timeStr = data.timestamp; }

            div.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <strong>${data.username}</strong>
                        <span>${timeStr}</span>
                    </div>
                    <div class="message-body">${data.message}</div>
                </div>
            `;
        }
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ‚úÖ Ïò§ÌÉÄ ÏàòÏ†ï ÏôÑÎ£å: ffunction -> function
    function updateParticipantsList(participants) {
        const pList = document.querySelector('#participants');
        const countSpan = document.querySelector('#count');
        pList.innerHTML = ''; 
        let onlineCount = 0;

        participants.forEach(p => {
            const isOnline = p.online === true || p.online === "true";
            if (isOnline) onlineCount++;
            
            const isLeader = String(p.id) === leaderId;
            const displayName = p.username || p.nickname;

            const li = document.createElement('li');
            li.className = 'participant-item';
            
            li.innerHTML = `
                <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                <span style="${isOnline ? 'color: #2e7d32; font-weight: bold;' : 'color: #888;'}">
                    ${isLeader ? '<span class="leader-crown">üëë</span>' : ''}
                    ${displayName}
                </span>
            `;
            pList.appendChild(li);
        });
        countSpan.textContent = `(${onlineCount}/${participants.length})`;
    }

    function sendMessage() {
        const input = document.querySelector('#chat-message-input');
        if (input.value.trim() && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({ 'message': input.value }));
            input.value = '';
        }
    }

    document.querySelector('#chat-message-submit').onclick = sendMessage;
    document.querySelector('#chat-message-input').onkeypress = e => { if(e.key === 'Enter') sendMessage(); };

    connect();
</script>
</body>
</html>