<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>{{ room.name }} ëŒ€ê¸°ì‹¤</title>

<style>
body {
    font-family: Arial, sans-serif;
}

.container {
    display: flex;
    gap: 20px;
}

/* ì±„íŒ… ì˜ì—­ */
.chat-area {
    flex: 3;
}

#chat-log {
    border: 1px solid #ccc;
    height: 300px;
    overflow-y: auto;
    padding: 10px;
}

/* ë©”ì‹œì§€ */
.message {
    display: flex;
    align-items: flex-start;
    margin-bottom: 10px;
}

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #4CAF50;
    color: white;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
}

.message-content {
    background: #f5f5f5;
    padding: 6px 10px;
    border-radius: 8px;
    max-width: 70%;
}

.message-header {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #555;
}

.system {
    color: gray;
    font-style: italic;
}

/* ì°¸ì—¬ì íŒ¨ë„ */
.participants-area {
    flex: 1;
    border: 1px solid #ddd;
    padding: 10px;
}

.participants-area h4 {
    margin-top: 0;
}

.participants-area li {
    list-style: none;
    margin-bottom: 6px;
}
</style>
</head>

<body>
<h1>{{ room.name }} ëŒ€ê¸°ì‹¤</h1>

<div class="container">

    <!-- ğŸ’¬ ì±„íŒ… -->
    <div class="chat-area">
        {% if can_chat %}
            <p style="color:green;">íšŒì˜ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        {% else %}
            <p style="color:red;">íšŒì˜ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
        {% endif %}

        <div id="chat-log"></div>

        <input id="chat-message-input" {% if not can_chat %}disabled{% endif %}>
        <button id="chat-message-submit" {% if not can_chat %}disabled{% endif %}>ì „ì†¡</button>
    </div>

    <!-- ğŸ‘¥ ì°¸ì—¬ì -->
    <div class="participants-area">
        <h4>ğŸ‘¥ ì°¸ì—¬ì
            <span style="font-size:14px; color:gray;">
                ({{ joined_members }}/{{ total_members }})
            </span>
        </h4>

        <ul id="participants">
            <li data-user-id="{{ leader.id }}">ğŸ‘‘ {{ leader.nickname }}</li>
            {% for p in participants %}
                {% if p.user_id.id != leader.id %}
                <li data-user-id="{{ p.user_id.id }}">
                    {{ p.user_id.nickname }}
                </li>
                {% endif %}
            {% endfor %}
        </ul>
    </div>

</div>

<script>
const roomName = "{{ room.slug }}";
const canChat = {{ can_chat|yesno:"true,false" }};
let socket = null;

function formatTime(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
    });
}

function updateParticipants(participants) {
    const ul = document.getElementById("participants");
    let onlineCount = 0;

    participants.forEach(p => {
        const li = ul.querySelector(`li[data-user-id="${p.id}"]`);
        if (!li) return;

        li.style.color = p.online ? "green" : "gray";
        li.style.fontWeight = p.online ? "bold" : "normal";

        if (p.online) onlineCount++;
    });

    document.getElementById("count").textContent =
        `(${onlineCount} / {{ total_members }})`;
}

function connect() {
    const protocol = location.protocol === "https:" ? "wss://" : "ws://";
    socket = new WebSocket(protocol + location.host + "/ws/chat/" + roomName + "/");

    socket.onmessage = e => {
        const data = JSON.parse(e.data);
        const chatLog = document.getElementById("chat-log");

        // ì‹œìŠ¤í…œ ë©”ì‹œì§€
        if (data.type === "system") {
            const p = document.createElement("p");
            p.className = "system";
            p.textContent = data.message;
            chatLog.appendChild(p);
        }

        // ì¼ë°˜ ì±„íŒ…
        if (data.type === "chat") {
            const wrapper = document.createElement("div");
            wrapper.className = "message";

            // ì•„ë°”íƒ€
            const avatar = document.createElement("div");
            avatar.className = "avatar";
            avatar.textContent = data.username[0];

            // ë‹‰ë„¤ì„ í‘œì‹œ
            const avatarName = document.createElement("div");
            avatarName.className = "avatar-name";
            avatarName.style.fontSize = "10px";
            avatarName.style.textAlign = "center";
            avatarName.textContent = data.username;

            const avatarWrapper = document.createElement("div");
            avatarWrapper.style.display = "flex";
            avatarWrapper.style.flexDirection = "column";
            avatarWrapper.style.alignItems = "center";
            avatarWrapper.appendChild(avatar);
            avatarWrapper.appendChild(avatarName);

            // ë©”ì‹œì§€ ë‚´ìš©
            const content = document.createElement("div");
            content.className = "message-content";

            const header = document.createElement("div");
            header.className = "message-header";
            header.innerHTML = `<span>${data.username}</span>
                        <span>${formatTime(data.timestamp)}</span>`;

            const body = document.createElement("div");
            body.textContent = data.message;

            content.appendChild(header);
            content.appendChild(body);

            wrapper.appendChild(avatarWrapper); // ì•„ë°”íƒ€+ë‹‰ë„¤ì„
            wrapper.appendChild(content);

            chatLog.appendChild(wrapper);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // ì°¸ì—¬ì ìƒíƒœ
        if (data.type === "participants") {
            updateParticipants(data.participants);
        }
    };

    socket.onclose = () => setTimeout(connect, 3000);
}

connect();

document.getElementById("chat-message-submit").onclick = () => {
    const input = document.getElementById("chat-message-input");
    if (!input.value) return;

    socket.send(JSON.stringify({ message: input.value }));
    input.value = "";
};
</script>
</body>
</html>
