<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ room.name }} - ëŒ€ê¸°ì‹¤</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        h1 { color: #1a73e8; font-size: 24px; }
        .container { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; height: 80vh; }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-area { flex: 3; display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .status-bar { padding: 10px 20px; border-bottom: 1px solid #eee; font-size: 14px; font-weight: bold; }
        
        #chat-log { flex: 1; overflow-y: auto; padding: 20px; background-color: #f9f9f9; display: flex; flex-direction: column; }
        
        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .message.self { justify-content: flex-end; }
        .message.other { justify-content: flex-start; }
        
        .message-content { padding: 10px 14px; border-radius: 12px; max-width: 60%; position: relative; font-size: 14px; line-height: 1.5; }
        .message.self .message-content { background: #fee500; color: #3c1e1e; border-top-right-radius: 2px; margin-right: 8px; }
        .message.other .message-content { background: white; border: 1px solid #ddd; border-top-left-radius: 2px; margin-left: 8px; }

        .avatar { width: 35px; height: 35px; border-radius: 50%; background: #4CAF50; color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .message-header { font-size: 11px; color: #888; margin-bottom: 4px; display: flex; gap: 8px; }
        .system { text-align: center; color: #888; font-size: 12px; margin: 10px 0; background: #eee; border-radius: 20px; padding: 2px 10px; align-self: center; }

        /* ì…ë ¥ì°½ */
        .input-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        #chat-message-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        #chat-message-submit { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #chat-message-submit:disabled { background: #ccc; }

        /* ì°¸ì—¬ì íŒ¨ë„ */
        .participants-area { flex: 1; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .participants-area h4 { margin-top: 0; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
        #participants { padding: 0; }
        .participant-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 14px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .online { background: #4CAF50; }
        .offline { background: #ccc; }
        .leader-crown { color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>

<h1>{{ room.name }} ëŒ€ê¸°ì‹¤</h1>

<div class="container">
    <div class="chat-area">
        <div class="status-bar">
            {% if can_chat %}
                <span style="color: #2e7d32;">â— íšŒì˜ ì§„í–‰ ì¤‘</span>
            {% else %}
                <span style="color: #d32f2f;">â—‹ íšŒì˜ ì‹œê°„ ì•„ë‹˜</span>
            {% endif %}
        </div>

        <div id="chat-log">
            {% for msg in messages %}
                {% if msg.type == "system" %}
                    <div class="system">{{ msg.message }}</div>
                {% else %}
                    <div class="message {% if msg.user_id|slugify == user.id|slugify %}self{% else %}other{% endif %}">
                        {% if msg.user_id|slugify != user.id|slugify %}
                            <div class="avatar">{{ msg.username|first }}</div>
                        {% endif %}
                        <div class="message-content">
                            <div class="message-header">
                                <strong>{{ msg.username }}</strong>
                                <span>{{ msg.timestamp }}</span>
                            </div>
                            <div class="message-body">{{ msg.message }}</div>
                        </div>
                        {% if msg.user_id|slugify == user.id|slugify %}
                            <div class="avatar">{{ msg.username|first }}</div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="input-area">
            <input id="chat-message-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." {% if not can_chat %}disabled{% endif %}>
            <button id="chat-message-submit" {% if not can_chat %}disabled{% endif %}>ì „ì†¡</button>
        </div>
    </div>

    <div class="participants-area">
        <h4>ğŸ‘¥ ì°¸ì—¬ì <span id="count" style="color:#888; font-weight:normal;">(0/{{ total_members }})</span></h4>
        <ul id="participants">
            </ul>
    </div>
</div>

<script>
    const roomName = "{{ room.slug }}";
    const currentUserId = "{{ user.id }}";
    const leaderId = "{{ leader.id }}";
    let chatSocket = null;

    // ìŠ¤í¬ë¡¤ í•˜ë‹¨ ê³ ì •
    const chatLog = document.querySelector('#chat-log');
    chatLog.scrollTop = chatLog.scrollHeight;

    function connect() {
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        chatSocket = new WebSocket(protocol + window.location.host + "/ws/chat/" + roomName + "/");

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === "chat" || data.type === "system") {
                renderMessage(data);
            } else if (data.type === "participants") {
                updateParticipantsList(data.participants);
            }
        };

        chatSocket.onclose = function(e) {
            console.log('ì†Œì¼“ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. 3ì´ˆ í›„ ì¬ì—°ê²°...');
            setTimeout(connect, 3000);
        };
    }

    function renderMessage(data) {
        if (data.type === "system") {
            const div = document.createElement('div');
            div.className = 'system';
            div.textContent = data.message;
            chatLog.appendChild(div);
        } else {
            const isSelf = String(data.user_id) === String(currentUserId);
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isSelf ? 'self' : 'other'}`;

            const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            msgDiv.innerHTML = `
                ${!isSelf ? `<div class="avatar">${data.username[0]}</div>` : ''}
                <div class="message-content">
                    <div class="message-header">
                        <strong>${data.username}</strong>
                        <span>${time}</span>
                    </div>
                    <div class="message-body">${data.message}</div>
                </div>
                ${isSelf ? `<div class="avatar">${data.username[0]}</div>` : ''}
            `;
            chatLog.appendChild(msgDiv);
        }
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function updateParticipantsList(participants) {
        const pList = document.querySelector('#participants');
        const countSpan = document.querySelector('#count');
        pList.innerHTML = '';
        let onlineCount = 0;

        participants.forEach(p => {
            if (p.online) onlineCount++;
            const isLeader = String(p.id) === String(leaderId);
            
            const li = document.createElement('li');
            li.className = 'participant-item';
            li.innerHTML = `
                <span class="status-dot ${p.online ? 'online' : 'offline'}"></span>
                <span>${isLeader ? '<span class="leader-crown">ğŸ‘‘</span> ' : ''}${p.username}</span>
                <span style="font-size: 10px; color: #888;">${p.online ? '(ì˜¨ë¼ì¸)' : ''}</span>
            `;
            pList.appendChild(li);
        });
        countSpan.textContent = `(${onlineCount}/${participants.length})`;
    }

    function sendMessage() {
        const input = document.querySelector('#chat-message-input');
        const message = input.value;
        if (message.trim()) {
            chatSocket.send(jsonStr = JSON.stringify({ 'message': message }));
            input.value = '';
        }
    }

    document.querySelector('#chat-message-submit').onclick = sendMessage;
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.key === 'Enter') sendMessage();
    };

    connect();
</script>

</body>
</html>