<h2>오늘의 미팅 알람</h2>
<div id="meeting-alerts" style="margin-bottom: 20px;"></div>

<ul>
{% for room in rooms %}
<li>
    <strong>{{ room.name }}</strong>
    {% if room.slug %}
        <a href="{% url 'chat:room-detail' room.slug %}?nickname=익명" data-slug="{{ room.slug }}">참여</a>
        <br>
        시작: {{ room.meeting.started_at|date:"Y-m-d H:i" }}<br>
        종료: {{ room.meeting.finished_at|date:"Y-m-d H:i" }}
    {% else %}
        (참여 불가)
        <br>
        시작: {{ room.meeting.started_at|date:"Y-m-d H:i" }}<br>
        종료: {{ room.meeting.finished_at|date:"Y-m-d H:i" }}
    {% endif %}
</li>
{% endfor %}
</ul>

<style>
#meeting-alerts div {
    background-color: #f0f8ff;
    border-left: 4px solid #007bff;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 4px;
}
#meeting-alerts a {
    margin-left: 10px;
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
}
#meeting-alerts a:hover {
    text-decoration: underline;
}
</style>

<script>
function createWebSocketConnection() {
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(protocol + window.location.host + '/ws/meeting-alerts/');

    let shownMeetingIds = new Set();

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (shownMeetingIds.has(data.meeting_id)) return;
        shownMeetingIds.add(data.meeting_id);

        const meetingAlerts = document.getElementById('meeting-alerts');
        const div = document.createElement('div');
        console.log(data)
        div.innerHTML = `
            <strong>${data.title}</strong> 미팅이 
            <span class="time">${data.started_at}</span>에 시작됩니다! 
            <a href="${data.join_url}">참여하기</a>
        `;
        meetingAlerts.prepend(div); // 새 알람이 위로
    };

    chatSocket.onopen = function() { console.log("WebSocket connected"); };
    chatSocket.onerror = function(e) { console.error("WebSocket error", e); };
    chatSocket.onclose = function() { console.log("WebSocket closed"); };
}

createWebSocketConnection();
</script>
