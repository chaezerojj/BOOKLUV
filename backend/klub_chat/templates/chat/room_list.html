<h2>ì˜¤ëŠ˜ì˜ ë¯¸íŒ… ì•ŒëŒ</h2>
<div id="meeting-alerts" style="margin-bottom: 20px;"></div>

<ul>
<h2>ì•ˆë…•í•˜ì„¸ìš” {{ user.nickname }}ë‹˜! ğŸ‘‹</h2>
<h3>ì˜¤ëŠ˜ì˜ ë¯¸íŒ… ì•ŒëŒ</h3>
<div id="meeting-alerts" style="margin-bottom: 20px;"></div>
{% for room in rooms %}
<li>
    <strong>{{ room.name }}</strong>
    {% if room.slug %}
        <a href="{% url 'chat:room-detail' room.slug %}?nickname=ìµëª…" data-slug="{{ room.slug }}">ì°¸ì—¬</a>
        <br>
        ì‹œì‘: {{ room.meeting.started_at|date:"Y-m-d H:i" }}<br>
        ì¢…ë£Œ: {{ room.meeting.finished_at|date:"Y-m-d H:i" }}
    {% else %}
        (ì°¸ì—¬ ë¶ˆê°€)
        <br>
        ì‹œì‘: {{ room.meeting.started_at|date:"Y-m-d H:i" }}<br>
        ì¢…ë£Œ: {{ room.meeting.finished_at|date:"Y-m-d H:i" }}
    {% endif %}
</li>
{% endfor %}
</ul>

<style>
#meeting-alerts div {
    background-color: #f0f8ff;
    border-left: 4px solid #007bff;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 4px;
}
#meeting-alerts a {
    margin-left: 10px;
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
}
#meeting-alerts a:hover {
    text-decoration: underline;
}
</style>

<script>
function createWebSocketConnection() {
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(protocol + window.location.host + '/ws/meeting-alerts/');

    let shownMeetingIds = new Set();

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (shownMeetingIds.has(data.meeting_id)) return;
        shownMeetingIds.add(data.meeting_id);

        const meetingAlerts = document.getElementById('meeting-alerts');
        const div = document.createElement('div');
        console.log(data)
        div.innerHTML = `
            <strong>${data.title}</strong> ë¯¸íŒ…ì´ 
            <span class="time">${data.started_at}</span>ì— ì‹œì‘ë©ë‹ˆë‹¤! 
            <a href="${data.join_url}">ì°¸ì—¬í•˜ê¸°</a>
        `;
        meetingAlerts.prepend(div); // ìƒˆ ì•ŒëŒì´ ìœ„ë¡œ
    };

    chatSocket.onopen = function() { console.log("WebSocket connected"); };
    chatSocket.onerror = function(e) { console.error("WebSocket error", e); };
    chatSocket.onclose = function() { console.log("WebSocket closed"); };
}

createWebSocketConnection();
</script>
